import asyncio
import os
import json
import logging
import time
import requests
from requests.auth import HTTPBasicAuth
from typing import Any, Dict, List

from fastapi import FastAPI, Form, BackgroundTasks
from fastapi.responses import Response
from twilio.rest import Client
from dotenv import load_dotenv

load_dotenv()

# -------------------------
# Configuration
# -------------------------
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger("whatsapp_webhook")

app = FastAPI()

TWILIO_ACCOUNT_SID = os.getenv("TWILIO_ACCOUNT_SID", "")
TWILIO_AUTH_TOKEN = os.getenv("TWILIO_AUTH_TOKEN", "")
TWILIO_WHATSAPP_FROM = os.getenv("TWILIO_WHATSAPP_FROM", "whatsapp:+14155238886")

twilio_client = Client(TWILIO_ACCOUNT_SID, TWILIO_AUTH_TOKEN)

# -------------------------
# DYNAMIC TEMPLATE CONFIGURATION
# -------------------------
TEMPLATE_SIDS = {
    2: "HX5c0ca19c79aa550301fa311403f6518a",
    3: "HX0cd36a7dfd8397ca2fa2082dde62dc6f",
    4: "HXfee1879cf2a8b515d1f56a27cbf656dd",
    5: "HX7d603ea61c4bf0057f80936439e9576e",
    10: "HX86b4c4d62a26a71dae214931b8855a51"
}

IMAGE_MAX_WIDTH = int(os.getenv("IMAGE_MAX_WIDTH", "1600"))
IMAGE_QUALITY = int(os.getenv("IMAGE_QUALITY", "95"))

# -------------------------
# Helper Functions
# -------------------------
def build_cdn_url(prod_id: str) -> str:
    if not prod_id: return ""
    return f"{prod_id}s.jpg?im=Resize,width={IMAGE_MAX_WIDTH},quality={IMAGE_QUALITY}"

def normalize_search_results(raw: Any) -> List[dict]:
    out: List[dict] = []
    if not raw: return out
    if isinstance(raw, dict):
        for k, v in raw.items():
            if isinstance(v, dict):
                meta = dict(v)
                if not any(x in meta for x in ("productId", "product_id", "id", "key", "prod_id")):
                    meta["product_id"] = k
                out.append(meta)
        return out
    if isinstance(raw, list):
        for item in raw:
            if isinstance(item, dict):
                out.append(item)
            elif isinstance(item, (list, tuple)) and item:
                if isinstance(item[0], dict):
                    out.append(item[0])
    return out

def load_json_response():
    try:
        with open("output.json", "r") as f:
            return json.load(f)
    except Exception as e:
        logger.error(f"âŒ Error loading output.json: {e}")
        return {}

# -------------------------
# ðŸŸ¢ CORRECT TYPING INDICATOR FUNCTION ðŸŸ¢
# -------------------------
def send_typing_indicator(original_message_sid: str):
    """
    Triggers the WhatsApp 'typing...' animation.
    CORRECTIONS:
    1. URL must end in .json
    2. Payload key must be 'messageId' (camelCase)
    """
    if not original_message_sid:
        return

    # Correct Endpoint with .json extension
    url = "https://messaging.twilio.com/v2/Indicators/Typing.json"
    
    payload = {
        "channel": "whatsapp",
        "messageId": original_message_sid  # Must be 'messageId', NOT 'MessageSid'
    }
    
    try:
        response = requests.post(
            url,
            data=payload,
            auth=HTTPBasicAuth(TWILIO_ACCOUNT_SID, TWILIO_AUTH_TOKEN)
        )
        
        if response.status_code in [200, 201]:
            logger.info(f"âœ… Typing started for {original_message_sid}")
        else:
            logger.error(f"âŒ Typing Failed (Status {response.status_code}): {response.text}")

    except Exception as e:
        logger.error(f"âŒ Error sending typing: {e}")

# -------------------------
# Background Logic
# -------------------------
def process_webhook_logic(Body: str, From: str, start_time: float, message_sid: str):
    user_number = From
    logger.info(f"Processing logic for {user_number}")

    # 1. TRIGGER TYPING (Now with correct URL/Params)
    send_typing_indicator(message_sid)

    # 2. LOAD DATA
    resp = load_json_response()
    assistant_message = resp.get("assistant_message", "Here are your products")
    raw_results = resp.get("search_results", [])
    products_found = normalize_search_results(raw_results)

    logger.info(f"Loaded {len(products_found)} products")

    # 3. CONDITIONAL CAROUSEL
    if products_found:
        count = len(products_found)
        if count >= 10: selected_sid = TEMPLATE_SIDS[10]; slice_limit = 10
        elif count >= 5: selected_sid = TEMPLATE_SIDS[5]; slice_limit = 5
        elif count >= 4: selected_sid = TEMPLATE_SIDS[4]; slice_limit = 4
        elif count >= 3: selected_sid = TEMPLATE_SIDS[3]; slice_limit = 3
        else: selected_sid = TEMPLATE_SIDS[2]; slice_limit = 2

        products_to_send = products_found[:slice_limit]
        while len(products_to_send) < slice_limit:
            products_to_send.append(products_to_send[0])

        content_variables = {}
        current_var_index = 2
        max_var_index = (slice_limit * 4) + 1

        for p in products_to_send:
            if current_var_index > max_var_index: break
            p_id = p.get("prod_id") or p.get("productId") or ""
            p_name = p.get("productName") or "Product"
            p_cat = p.get("productCategory") or "General"
            p_price = p.get("price", "0.00")
            p_url = p.get("url") or ""

            content_variables[str(current_var_index)] = build_cdn_url(p_id)
            current_var_index += 1
            content_variables[str(current_var_index)] = p_name[:30] + "..." if len(p_name) > 30 else p_name
            current_var_index += 1
            content_variables[str(current_var_index)] = f"Â£{p_price} | {p_cat}"
            current_var_index += 1
            content_variables[str(current_var_index)] = p_url.replace("https://www.next.co.uk/style/", "").replace("https://next.co.uk/style/", "")
            current_var_index += 1

        try:
            # Sending a message stops the typing indicator automatically
            twilio_client.messages.create(
                content_sid=selected_sid,
                from_=TWILIO_WHATSAPP_FROM,
                to=user_number,
                content_variables=json.dumps(content_variables)
            )
            logger.info("Carousel sent.")
            
            # Wait 3s so text doesn't arrive before images
            time.sleep(3.0)
            
        except Exception as e:
            logger.error(f"Failed to send carousel: {e}")
    else:
        logger.info("No products. Skipping carousel.")

    # 4. SEND TEXT
    try:
        twilio_client.messages.create(
            body=assistant_message,
            from_=TWILIO_WHATSAPP_FROM,
            to=user_number
        )
        logger.info("Assistant message sent.")
    except Exception as e:
        logger.error(f"Failed to send text: {e}")

    duration = time.time() - start_time
    logger.info(f"âœ… Transaction Complete in {duration:.2f}s")

# -------------------------
# Webhook Endpoint
# -------------------------
@app.post("/whatsapp/webhook")
async def whatsapp_webhook(
    background_tasks: BackgroundTasks, 
    Body: str = Form(...), 
    From: str = Form(...),
    MessageSid: str = Form(...) # Capture the Incoming Message SID
):
    start_time = time.time()
    logger.info(f"Msg from {From}")
    
    # We pass MessageSid to the background task
    background_tasks.add_task(process_webhook_logic, Body, From, start_time, MessageSid)
    
    return Response(content="<Response></Response>", media_type="application/xml")



Domain,Type,Notes
accounts.twilio.com,API Endpoint,Authentication and Account Management
api.twilio.com,API Endpoint,Core API (Calls, Messages, etc.)
api.dublin.ie1.twilio.com,API Endpoint,Regional Core API (EU/Ireland)
api.sydney.au1.twilio.com,API Endpoint,Regional Core API (APAC/Australia)
api.ashburn.us1.twilio.com,API Endpoint,Regional Core API (US East)
bulkexports.twilio.com,API Endpoint,Bulk Export API
chat.twilio.com,API Endpoint,Programmable Chat (Legacy)
console.twilio.com,Web Interface,Twilio Console (Referenced in docs)
content.twilio.com,API Endpoint,Content API
conversations.twilio.com,API Endpoint,Conversations API
email.twilio.com,API Endpoint,Twilio Email / SendGrid Integration
events.twilio.com,API Endpoint,Event Streams
flex-api.twilio.com,API Endpoint,Flex Contact Center API
insights.twilio.com,API Endpoint,Call & TaskRouter Insights
ip-messaging.twilio.com,API Endpoint,IP Messaging (Legacy reference)
lookups.twilio.com,API Endpoint,Phone Number Lookups
mcs.us1.twilio.com,API Endpoint,Media Conversion Service (US1)
media.twilio.com,API Endpoint,Media Storage API
messaging.twilio.com,API Endpoint,Messaging Services API
microvisor.twilio.com,API Endpoint,Microvisor IoT API
monitor.twilio.com,API Endpoint,Monitor/Alerts API
numbers.twilio.com,API Endpoint,Phone Numbers API
preview.twilio.com,API Endpoint,Developer Preview / Beta APIs
pricing.twilio.com,API Endpoint,Pricing Information
proxy.twilio.com,API Endpoint,Proxy API
routes.twilio.com,API Endpoint,SIP Routes
serverless.twilio.com,API Endpoint,Twilio Functions/Serverless
studio.twilio.com,API Endpoint,Studio Flow API
supersim.twilio.com,API Endpoint,Super SIM API
sync.twilio.com,API Endpoint,Sync State API
taskrouter.twilio.com,API Endpoint,TaskRouter API
trunking.twilio.com,API Endpoint,SIP Trunking
twimlets.com,Utility Service,Hosted TwiML utilities (echo, hold music, etc.)
verify.twilio.com,API Endpoint,Verify / 2FA API
video.twilio.com,API Endpoint,Programmable Video
voice.twilio.com,API Endpoint,Voice API
wireless.twilio.com,API Endpoint,Wireless / IoT
www.twilio.com,Website,Documentation and Marketing
twilio.org,Website,Twilio.org (Social Impact) - Documentation refs
github.com,Source Control,Repository hosting (Installation/Setup)
pypi.org,Package Repo,Python Package Index (Installation)
